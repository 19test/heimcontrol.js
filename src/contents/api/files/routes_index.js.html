<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>routes&#x2F;index.js - heimcontrol.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title="heimcontrol.js"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/Arduino.html">Arduino</a></li>
            
                <li><a href="..&#x2F;classes/Controller.html">Controller</a></li>
            
                <li><a href="..&#x2F;classes/Gpio.html">Gpio</a></li>
            
                <li><a href="..&#x2F;classes/PluginHelper.html">PluginHelper</a></li>
            
                <li><a href="..&#x2F;classes/StringBuffer.html">StringBuffer</a></li>
            
                <li><a href="..&#x2F;classes/Wakeonlan.html">Wakeonlan</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: routes&#x2F;index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
if (typeof define !== &#x27;function&#x27;) {
  var define = require(&#x27;amdefine&#x27;)(module);
}

define([ &#x27;crypto&#x27;, &#x27;cookie&#x27;, &#x27;fs&#x27; ], function(crypto, cookie, fs) {

  &#x2F;**
   * Helper class to concat strings
   *
   * @class StringBuffer
   * @constructor 
   *&#x2F;
  var StringBuffer = function() {
    this.buffer = [];
    this.index = 0;
  };

  StringBuffer.prototype = {
    &#x2F;** 
     * Append a string at the end of the StringBuffer 
     * 
     * @method append
     * @param {String} s The string to append
     *&#x2F;
    append: function(s) {
      this.buffer[this.index++] = s;
      return this;
    },

    &#x2F;**
     * Return the string representation of the StringBuffer
     * 
     * @method toString
     *&#x2F;
    toString: function() {
      return this.buffer.join(&quot;&quot;);
    }
  };
  
  &#x2F;**
   * Route-Controller
   *
   * @class Controller
   * @constructor 
   *&#x2F;
  var Controller = {};

  &#x2F;** 
   * Recursive function to render all plugin items to on page to show them on the startpage. 
   * 
   * @method renderPluginItems
   * @param {Object} app The express app
   * @param {String} res The type to render (&#x27;settings&#x27; or &#x27;view&#x27;)
   * @param {Integer} i The iterator for the plugins
   * @paran {String} html A string containing the already rendered plugin items
   * @param {Function} callback The callback method to execute after rendering
   * @param {String} callback.err null if no error occured, otherwise the error
   * @param {String} callback.result The rendered HTML string
   *&#x2F;
  function renderPluginItems(app, type, i, html, callback) {
    var plugins = app.get(&#x27;plugins&#x27;);
    var plugin = plugins[i];
    app.get(&#x27;db&#x27;).collection(plugin.collection, function(err, collection) {
      if (err) {
        return callback(err);
      }
      collection.find({}).toArray(function(err, items) {
        if (err) {
          return callback(err);
        }
        if (items.length &gt; 0) {

          function render(items) {
            app.get(&#x27;jade&#x27;).renderFile(__dirname + &#x27;&#x2F;..&#x2F;plugins&#x2F;&#x27; + plugin.id + &#x27;&#x2F;views&#x2F;&#x27; + type + &#x27;.jade&#x27;, {
              items: items
            }, function(err, result) {
              if (!err) {
                html.append(result);
              } else {
                console.log(err);
              }
            });
          }

          &#x2F;&#x2F; If the plugin has a beforeRender() method, call it
          if (plugin.beforeRender) {
            plugin.beforeRender(items, function(err, result) {
              render(result);
            });
          } else {
            render(items);
          }

        }
        if (++i &lt; plugins.length) {
          renderPluginItems(app, type, i, html, callback);
        } else {
          return callback(null, html);
        }
      });
    });
  }

  &#x2F;** 
   * Recursive function to combine javascript and css files from the plugins
   * 
   * @method combinePluginFiles
   * @param {Object} fileList An array containing the files to combine
   * @param {String} fileList.name The name of the file to combine
   * @param {String} fileList.type The type of the file (e.g. &#x27;js&#x27; or &#x27;css&#x27;)
   * @param {Function} callback The callback method to execute after rendering
   * @param {String} callback.err null if no error occured, otherwise the error
   * @param {String} callback.result The rendered HTML string
   * @param {Object} sb *optional* StringBuffer containing the already combined files
   *&#x2F;
  function combinePluginFiles(fileList, callback, sb) {
    if (!sb) {
      sb = new StringBuffer();
    }
    var file = fileList.pop();
    var filename = __dirname + &#x27;&#x2F;..&#x2F;plugins&#x2F;&#x27; + file.name + &#x27;&#x2F;public&#x2F;&#x27; + file.type + &#x27;&#x2F;&#x27; + file.name + &#x27;.&#x27; + file.type;
    fs.readFile(filename, &#x27;utf8&#x27;, function(err, data) {
      if (!err) {
        sb.append(data);
      } else {
        console.log(err);
      }
      if (fileList.length &gt; 0) {
        combinePluginFiles(fileList, callback, sb);
      } else {
        return callback(null, sb.toString());
      }
    });
  }

  &#x2F;**
   * GET &#x2F;
   * 
   * @method index
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.index = function(req, res) {
    var html = new StringBuffer();
    renderPluginItems(req.app, &#x27;item&#x27;, 0, html, function(err, html) {
      if (!err) {
        return res.render(&#x27;index&#x27;, {
          title: &#x27;Home&#x27;,
          content: html.toString()
        });
      } else {
        return res.render(500, &#x27;500&#x27;);
      }
    });
  };

  &#x2F;**
   * GET &#x2F;settings
   * 
   * @method settings
   * @param {Object} req The request
   * @param {Object} res The response
   * @param {Object} next Next route
   *&#x2F;
  Controller.settings = function(req, res, next) {
    if (req.params.plugin) {
      var pluginList = [];
      req.app.get(&#x27;plugins&#x27;).forEach(function(plugin) {
        pluginList.push(plugin.id);
      });
      if (pluginList.indexOf(req.params.plugin) &gt;= 0) {
        req.app.get(&#x27;plugins&#x27;).forEach(function(plugin) {
          if (plugin.id == req.params.plugin) {
            req.app.get(&#x27;db&#x27;).collection(plugin.collection, function(err, collection) {
              collection.find({}).toArray(function(err, items) {
                req.app.get(&#x27;jade&#x27;).renderFile(__dirname + &#x27;&#x2F;..&#x2F;plugins&#x2F;&#x27; + plugin.id + &#x27;&#x2F;views&#x2F;settings.jade&#x27;, {
                  items: items
                }, function(err, html) {
                  if (!err) {
                    return res.render(&#x27;plugin-settings&#x27;, {
                      content: html,
                      plugin: plugin.id,
                      title: plugin.name + &#x27; Settings&#x27;
                    });
                  } else {
                    console.log(err);
                    return res.render(500, &#x27;500&#x27;, {
                      title: &#x27;500 Internal Server Error&#x27;
                    });
                  }
                });
              });
            });
          }
        });
      } else {
        return next();
      }
    } else {
      return res.render(&#x27;settings&#x27;, {
        title: &quot;Settings&quot;
      });
    }
  };

  &#x2F;**
   * POST &#x2F;settings
   * 
   * @method saveSettings
   * @param {Object} req The request
   * @param {Object} res The response
   * @param {Object} next Next route
   *&#x2F;
  Controller.saveSettings = function(req, res, next) {
    if (req.params.plugin) {
      var pluginList = [];
      req.app.get(&#x27;plugins&#x27;).forEach(function(plugin) {
        pluginList.push(plugin.id);
      });
      if (pluginList.indexOf(req.params.plugin) &gt;= 0) {
        req.app.get(&#x27;plugins&#x27;).forEach(function(plugin) {
          if (plugin.id == req.params.plugin) {
            
            var items = req.body.data;

            &#x2F;**
             * Recursive function to save items to collections
             *&#x2F;
            function saveMultiple(app, collection, items, callback) {
              if ((items) &amp;&amp; (items.length &gt; 0)) {
                var item = items.shift();
                if (item._id) {
                  var ObjectID = app.get(&#x27;mongo&#x27;).ObjectID;
                  item._id = new ObjectID(item._id + &#x27;&#x27;);
                }
                collection.save(item, function(err, result) {
                  if (items.length &gt; 0) {
                    saveMultiple(app, collection, items, callback);
                  } else {
                    callback(null, true);
                  }
                });
              } else {
                callback(null, true);
              }
            }

            &#x2F;&#x2F; TODO: Each plugin should have a &quot;validate()&quot; method to check if the items-data is valid
            req.app.get(&#x27;db&#x27;).collection(plugin.collection, function(err, collection) {
              collection.remove({}, function(err, result) {
                saveMultiple(req.app, collection, items, function(err, result) {
                  req.app.get(&#x27;events&#x27;).emit(&#x27;settings-saved&#x27;);
                  collection.find({}).toArray(function(err, items) {
                    req.app.get(&#x27;jade&#x27;).renderFile(__dirname + &#x27;&#x2F;..&#x2F;plugins&#x2F;&#x27; + plugin.id + &#x27;&#x2F;views&#x2F;settings.jade&#x27;, {
                      items: items,
                      success: &#x27;Settings have been updated&#x27;
                    }, function(err, html) {
                      if (!err) {
                        return res.render(&#x27;plugin-settings&#x27;, {
                          content: html,
                          plugin: plugin.id,
                          title: plugin.name + &#x27; Settings&#x27;
                        });
                      } else {
                        console.log(err);
                        return res.render(500, &#x27;500&#x27;, {
                          title: &#x27;500 Internal Server Error&#x27;
                        });
                      }
                    });
                  });
                });
              });
            });
          }
        });
      } else {
        return next();
      }
    } else {
      return next();
    }
  };

  &#x2F;**
   * GET &#x2F;register
   * 
   * @method register
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.showRegister = function(req, res) {
    req.app.get(&#x27;db&#x27;).collection(&#x27;User&#x27;, function(err, u) {
      u.find({}).toArray(function(err, r) {
        if (r.length == 0) {
          return res.render(&#x27;register&#x27;, {
            title: &quot;Register&quot;,
            hide_menubar: true
          });
        } else {
          return res.redirect(&#x27;&#x2F;&#x27;);
        }
      });
    });
  };

  &#x2F;**
   * POST &#x2F;register
   * 
   * @method doRegister
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.doRegister = function(req, res) {
    req.app.get(&#x27;db&#x27;).collection(&#x27;User&#x27;, function(err, u) {
      u.find({}).toArray(function(err, r) {
        if (r.length == 0) {
          var email = req.body.email || &#x27;&#x27;;
          var password = crypto.createHash(&#x27;sha256&#x27;).update(req.body.password || &#x27;&#x27;).digest(&quot;hex&quot;);
          var password2 = crypto.createHash(&#x27;sha256&#x27;).update(req.body.repeatpassword || &#x27;&#x27;).digest(&quot;hex&quot;);

          if (password != password2) {
            return res.render(&#x27;register&#x27;, {
              title: &#x27;Register&#x27;,
              error: &#x27;Passwords did not match.&#x27;,
              hide_menubar: true
            });
          } else {
            if (email == &#x27;&#x27;) {
              return res.render(&#x27;register&#x27;, {
                title: &#x27;Register&#x27;,
                error: &#x27;Please enter an email address.&#x27;,
                hide_menubar: true
              });
            } else {
              req.app.get(&#x27;db&#x27;).collection(&#x27;User&#x27;, function(err, u) {
                u.save({
                  &#x27;email&#x27;: email,
                  &#x27;password&#x27;: password
                }, function(err, result) {
                  return res.render(&#x27;login&#x27;, {
                    title: &#x27;Login&#x27;,
                    success: &#x27;Registration completed. You can now login.&#x27;,
                    hide_menubar: true
                  });
                });
              });
            }
          }
        }
      });
    });
  };

  &#x2F;**
   * GET &#x2F;login
   * 
   * @method showLogin
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.showLogin = function(req, res) {
    &#x2F;&#x2F; If no user exists, redirect to register
    req.app.get(&#x27;db&#x27;).collection(&#x27;User&#x27;, function(err, u) {
      u.find({}).toArray(function(err, r) {
        if (r.length == 0) {
          return res.redirect(&#x27;&#x2F;register&#x27;);
        } else {
          var c = cookie.parse(req.headers.cookie);
          if ((!err) &amp;&amp; (c.email) &amp;&amp; (c.password)) {
            return Controller.doLogin(req, res);
          } else {
            return res.render(&#x27;login&#x27;, {
              title: &#x27;Login&#x27;,
              hide_menubar: true
            });
          }
        }
      });
    });
  };

  &#x2F;**
   * POST &#x2F;login
   * 
   * @method doLogin
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.doLogin = function(req, res) {

    var c = cookie.parse(req.headers.cookie);
    var email = req.body.email || c.email || &#x27;&#x27;;
    var password = crypto.createHash(&#x27;sha256&#x27;).update(req.body.password || c.password || &#x27;&#x27;).digest(&quot;hex&quot;);
    req.app.get(&#x27;db&#x27;).collection(&#x27;User&#x27;, function(err, u) {
      u.find({
        &#x27;email&#x27;: email,
        &#x27;password&#x27;: password
      }).toArray(function(err, r) {
        if (r.length == 0) {
          return res.render(&#x27;login&#x27;, {
            title: &#x27;Login&#x27;,
            error: &#x27;Login failed, wrong email&#x2F;password combination.&#x27;,
            hide_menubar: true
          });
        } else {
          req.session.user = r[0];
          return res.redirect(&#x27;&#x2F;&#x27;);
        }
      });
    });
  };

  &#x2F;**
   * GET &#x2F;logout
   * 
   * @method logout
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.logout = function(req, res) {
    req.session.user = null;
    res.render(&#x27;login&#x27;, {
      title: &#x27;Login&#x27;,
      hide_menubar: true,
      success: &#x27;You are now logged out.&#x27;
    });
  };

  &#x2F;**
   * POST &#x2F;settings
   * 
   * @method changePassword
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.changePassword = function(req, res) {

    var password = crypto.createHash(&#x27;sha256&#x27;).update(req.body.oldpassword || &#x27;&#x27;).digest(&quot;hex&quot;);
    var newpassword = crypto.createHash(&#x27;sha256&#x27;).update(req.body.newpassword || &#x27;&#x27;).digest(&quot;hex&quot;);
    var newpassword2 = crypto.createHash(&#x27;sha256&#x27;).update(req.body.repeatnewpassword || &#x27;&#x27;).digest(&quot;hex&quot;);

    if (newpassword != newpassword2) {
      return res.render(&#x27;settings&#x27;, {
        title: &#x27;Settings&#x27;,
        error: &#x27;New passwords did not match.&#x27;
      });
    } else {
      req.app.get(&#x27;db&#x27;).collection(&#x27;User&#x27;, function(err, u) {
        u.find({
          &#x27;email&#x27;: req.session.user.email,
          &#x27;password&#x27;: password
        }).toArray(function(err, r) {
          if (r.length == 0) {
            return res.render(&#x27;settings&#x27;, {
              title: &#x27;Settings&#x27;,
              error: &#x27;Old password wrong.&#x27;
            });
          } else {
            r[0].password = newpassword;
            u.save(r[0], function(err, result) {
              return res.render(&#x27;settings&#x27;, {
                title: &#x27;Settings&#x27;,
                success: &#x27;Your password has been changed.&#x27;
              });
            });
          }
        });
      });
    }
  };

  &#x2F;**
   * GET &#x2F;js&#x2F;plugins.js
   * 
   * Load the plugin javascripts into one file and returns it
   *
   * @method pluginsJs
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.pluginsJs = function(req, res) {
    var fileList = [];
    req.app.get(&#x27;plugins&#x27;).forEach(function(plugin) {
      fileList.push(
        {
          name: plugin.id,
          type: &#x27;js&#x27;
        }
      );
    });
    if (fileList.length &gt; 0) {
      combinePluginFiles(fileList, function(err, result) {
        res.charset = &#x27;utf-8&#x27;;
        res.setHeader(&#x27;Content-Type&#x27;, &#x27;text&#x2F;javascript&#x27;);
        return res.send(200, result);
      });
    } else {
      return res.send(200, &#x27;&#x27;);
    }
  }

  &#x2F;**
   * GET &#x2F;js&#x2F;plugins.css
   * 
   * Load the plugin css into one file and returns it
   *
   * @method pluginsCss
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.pluginsCss = function(req, res) {
    var fileList = [];
    req.app.get(&#x27;plugins&#x27;).forEach(function(plugin) {
      fileList.push(
        {
          name: plugin.id,
          type: &#x27;css&#x27;
        }
      );
    });
    if (fileList.length &gt; 0) {
      combinePluginFiles(fileList, function(err, result) {
        res.charset = &#x27;utf-8&#x27;;
        res.setHeader(&#x27;Content-Type&#x27;, &#x27;text&#x2F;css&#x27;);
        return res.send(200, result);
      });
    } else {
      return res.send(200, &#x27;&#x27;);
    }
  }

  &#x2F;**
   * Error 404
   *
   * @method notFound
   * @param {Object} req The request
   * @param {Object} res The response
   *&#x2F;
  Controller.notFound = function(req, res) {
    res.status(404).render(&#x27;404&#x27;, {
      title: &#x27;404 Not Found&#x27;,
      hide_menubar: ((req.session) &amp;&amp; (req.session.user))
    });
  };

  &#x2F;**
   * Authorization chec
   *
   * @method isAuthorized
   * @param {Object} req The request
   * @param {Object} res The response
   * @param {Object} next The next route
   *&#x2F;
  Controller.isAuthorized = function(req, res, next) {
    if (!req.session.user) {
      return res.redirect(&#x27;&#x2F;login&#x27;);
    } else {
      next();
    }
  };

  var exports = Controller;

  return exports;

});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
